# DATUM Bot - Telegram-бот ассистент для бренда DATUM

Telegram-бот для работы с покупателями парфюмерии DATUM. Подключается через QR/визитку в упаковке, собирает информацию о заказах, отзывах и обеспечивает поддержку клиентов.

## Возможности

- ✅ Подключение через QR/визитку в упаковке
- ✅ Выбор платформы покупки (Wolt, Uzum, ЯндексМаркет, OLX, Другое)
- ✅ Поиск заказа по номеру или фото чека
- ✅ Информация о товаре, альтернативы, сезонные рекомендации
- ✅ Сбор контактов клиентов (имя, телефон)
- ✅ Система отзывов (оценка 1-5 + комментарий)
- ✅ Поддержка клиентов (обратный звонок, чат с менеджером, email)
- ✅ Уведомления менеджерам о новых отзывах и обращениях
- ✅ Админ-панель для просмотра отзывов и запросов поддержки
- ✅ Логирование всех диалогов в БД

## Технологии

- Node.js
- Telegraf (Telegram Bot API)
- Express.js
- PostgreSQL
- pg (PostgreSQL driver)

## Установка

1. Клонируйте репозиторий или скачайте файлы

2. Установите зависимости:
```bash
npm install
```

3. Настройте PostgreSQL:
   - Установите PostgreSQL
   - Создайте базу данных:
   ```sql
   CREATE DATABASE datum_bot;
   ```

4. Настройте переменные окружения:
   - Создайте файл `.env` на основе примера ниже
   - Заполните все необходимые переменные:
   ```
   # Основной бот для пользователей
   TELEGRAM_BOT_TOKEN=your_bot_token_here
   TELEGRAM_BOT_USERNAME=your_bot_username_here
   
   # Админский бот (отдельный бот для администратора)
   TELEGRAM_ADMIN_BOT_TOKEN=your_admin_bot_token_here
   TELEGRAM_ADMIN_BOT_USERNAME=your_admin_bot_username_here
   TELEGRAM_ADMIN_ID=your_telegram_user_id_here
   
   # База данных
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=datum_bot
   DB_USER=postgres
   DB_PASSWORD=postgres
   ```

5. Запустите миграции БД:
```bash
node src/db/migrate.js
```

6. Запустите бота:
```bash
# Development mode (polling)
npm run dev

# Production mode
npm start
```

## Структура проекта

```
datum-bot/
├── src/
│   ├── admin/          # Админ-панель (веб-интерфейс)
│   ├── config/         # Конфигурация (переменные окружения)
│   ├── db/             # Работа с БД
│   │   ├── migrations/ # Миграции БД
│   │   ├── connection.js
│   │   ├── services.js # Сервисы для работы с БД
│   │   └── migrate.js  # Скрипт миграций
│   ├── handlers/       # Обработчики (контакты, фото)
│   ├── middleware/     # Middleware (состояние пользователя)
│   ├── utils/          # Утилиты (NLP, уведомления)
│   └── index.js        # Главный файл бота
├── .env.example        # Пример переменных окружения
├── package.json
└── README.md
```

## Использование

### Для пользователей

1. Отсканируйте QR-код или перейдите по ссылке из визитки
2. Выберите платформу покупки
3. Введите номер заказа или загрузите фото чека
4. Используйте меню для получения информации, отзывов и поддержки

### Для администраторов

Используйте отдельный админский бот в Telegram:
1. Найдите вашего админского бота по username (из `.env`)
2. Запустите команду `/start` или `/dashboard`
3. Доступные команды:
   - `/dashboard` - Главная панель со статистикой
   - `/reviews` - Последние отзывы
   - `/support` - Активные запросы поддержки
   - `/low_rating` - Отзывы с низким рейтингом (≤2⭐)
   - `/stats` - Подробная статистика
   - `/help` - Справка

**Важно:** Только пользователь с ID из `TELEGRAM_ADMIN_ID` может использовать админский бот.

## API Endpoints

- `POST /webhook/telegram` - Webhook для основного бота (пользователи)
- `POST /webhook/admin` - Webhook для админского бота
- `GET /health` - Проверка состояния сервера и БД

## База данных

Бот использует PostgreSQL со следующими таблицами:
- `users` - пользователи Telegram
- `products` - товары/продукция
- `orders` - заказы
- `reviews` - отзывы
- `dialogs` - логи диалогов
- `support_requests` - запросы поддержки

## Конфигурация

Все настройки находятся в файле `.env`. Обязательные переменные:

**Основной бот (для пользователей):**
- `TELEGRAM_BOT_TOKEN` - токен основного бота от @BotFather
- `TELEGRAM_BOT_USERNAME` - username основного бота

**Админский бот (для администраторов):**
- `TELEGRAM_ADMIN_BOT_TOKEN` - токен админского бота от @BotFather (отдельный бот!)
- `TELEGRAM_ADMIN_BOT_USERNAME` - username админского бота
- `TELEGRAM_ADMIN_ID` - Telegram ID администратора (можно получить у @userinfobot)

**База данных:**
- `DB_HOST`, `DB_PORT`, `DB_NAME`, `DB_USER`, `DB_PASSWORD` - настройки PostgreSQL

**Важно:** Создайте два отдельных бота через @BotFather - один для пользователей, другой для админа.

## Разработка

```bash
# Режим разработки с автоперезагрузкой
npm run dev

# Запуск миграций
node src/db/migrate.js
```

## Лицензия

ISC

